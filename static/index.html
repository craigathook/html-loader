<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <title>html loader</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no'>
    <script src='https://s0.2mdn.net/ads/studio/Enabler.js'> </script>
  </head>
  <style>
    #adContainer {
      position: relative;
      height:600px;
      width:300px;
      background: gray;
    }
    #background {
      display:block;
      height: 100%;
      width: 100%;
      position: absolute;
    }

    .button {
      font-family:Arial;
      position: relative;
      width: 150px;
      padding:5px;
      text-align: center;
      align-items: center;
      background: blue;
      color: white;
      border-radius: 4px;
      margin: 10px auto;
      top:200px;
      cursor: pointer;
    }
  </style>

  <body unresolved>
  <!-- <object type='text/html' data='elements/loader-main.html'></object> -->
  <div id='adContainer'>
    <div id='background'></div>
    <div id='btn1' class='button'>BACKGROUND 1</div>
    <div id='btn2' class='button'>BACKGROUND 2</div>
    <div id='btn3' class='button'>BACKGROUND 3</div>
  </div>
  </body>
  <script>
    console.log('index');
    var assetsLoading = 0;

    function loadHTML(url, target, callback){
      var xhr= new XMLHttpRequest();
      xhr.open('GET', url, true);

      xhr.onreadystatechange = function() {
        if (this.readyState!==4) return;
        if (this.status!==200) return;

        var timeStamp = new Date().getTime();
        
        var res = this.responseText;

        // turn into module. innerHTML automatically removes body and head tags if they aren't renamed.
        res = res.replace('/body>', '/body'+timeStamp+'>').replace('<body', '<body'+timeStamp); 
        res = res.replace('/head>', '/head'+timeStamp+'>').replace('<head', '<head'+timeStamp);

        var scripts = getScripts(this.responseText);

        window.res = res;

        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = res;

        var moduleStyle = tempDiv.getElementsByTagName('style')[0];
        var moduleBody = tempDiv.getElementsByTagName('body'+timeStamp)[0];
        var moduleHead = tempDiv.getElementsByTagName('head'+timeStamp)[0];
        var moduleScripts = tempDiv.getElementsByTagName('script');
        var moduleImages = tempDiv.getElementsByTagName('img');

        console.log('moduleScripts',moduleScripts)

        var scripts = [];
        var images = [];
        var assets = [];
        var scriptElements = [];

        for(var s in moduleScripts){ // could be refactored into getSourceFromElements
          var scriptElement = moduleScripts[s];

          if(scriptElement['attributes']){
            if(scriptElement['attributes']['src']) {
              scripts.push(scriptElement.attributes.src.value);
            } else {
              console.log('sadsadsdasa', scriptElement)
              scriptElements.push(scriptElement);
            }
          } 
        }

        for(var i in moduleImages){
          var imgElement = moduleImages[i];

          if(imgElement['attributes']){
            if(imgElement['attributes']['src']) {
              images.push(imgElement.attributes.src.value);
            }
          }
        }

        console.log(scripts, images);

        assets = assets.concat(scripts, images);

        console.log(assets);

        for(var a in assets){
          loadAsset(assets[a], function(){

          target.innerHTML = (moduleBody.innerHTML+moduleHead.innerHTML);
          target.appendChild(moduleStyle); 

          console.log('scriptElements',scriptElements)

          for(var e in scriptElements) { // add all inline javascript
            console.log(">",scriptElement);
            var scriptElement = scriptElements[e];
            var newElement = document.createElement('script');
            newElement.text = scriptElement.innerHTML;
            target.appendChild(newElement);
          }

          callback ? callback() : false; // run callback if it exists

          //var linkTag = document.createElement('link');
          //linkTag.rel = 'import';
          //linkTag.href = url;

          //document.getElementsByTagName('head')[0].appendChild(linkTag);

          });
        }
      }

      xhr.send();
    }

    function addCode(code){
      
    }

    function stripScripts(s) {
      var div = document.createElement('div');
      div.innerHTML = s;
      return div.getElementsByTagName('script');
    }

    function getScripts(s) {
      var div = document.createElement('div');
      div.innerHTML = s;
      var scripts = div.getElementsByTagName('script');
      var i = scripts.length;
      while (i--) {
        scripts[i].parentNode.removeChild(scripts[i]);
      }
      return div.innerHTML;
    }

    btn1.onclick = function(){
      loadHTML('bg1.html', document.getElementById('background'));
    };
    btn2.onclick = function(){
      loadHTML('bg2.html', document.getElementById('background'));
    };
    btn3.onclick = function(){
      loadHTML('bg3.html', document.getElementById('background'));
    };

    function loadAsset(file, callback) {

      var loadingContainer = document.createElement('div');
      loadingContainer.style.display = 'none';

      document.body.appendChild(loadingContainer);

      var element = null;
      var elementType = null;

      var isImage = (file.indexOf('.png') + file.indexOf('.gif') + file.indexOf('.jpg') + file.indexOf('.jpeg') + file.indexOf('.svg')) > -1;
      var isJavaScript = file.indexOf('.js') > -1;

      if(isJavaScript) {

        element = document.createElement('script');
        element.type = 'application/javascript';
        
      }

      if(isImage) {

        element = document.createElement('img');
        
      }

      element.src = file;

      loadingContainer.appendChild(element);

      assetsLoading++;

      element.onload = function(){

        assetsLoading--;
        if(assetsLoading == 0) {

          console.log('All Assets Loaded.');
          callback ? callback() : false;

          loadingContainer.parentNode.removeChild(loadingContainer);

        }

      }
      // finally insert the element to the body element in order to load the script

    }

    
    // Find: ([,|\}][\s$]*)([\.#]?-?[_a-zA-Z]+[_a-zA-Z0-9-]*)
    // Replace with: $1#content $2

    // Breakdown of Regex

    // ([,|\}][\s$]*) - Finds the } or , from the previous style followed by whitespace (spaces/tabs: \s, newlines: $). The closing brace\comma keeps the regex from looking inside the body of your style.
    // [\.#]? - Matches the starting # or . in the style name, if it is present.
    // -?[_a-zA-Z]+ - CSS style names can start with an underscore or letters. Also, style names can be prepended by a dash.
    // [_a-zA-Z0-9-]* - Matches the rest of the style name. This can be omitted, but it might be nice to know the style name of all the styles that were modified.
    // $1#content $2 - The } (or ,) and whitespace is left the way it was found ($1). It is followed by your inserted text #content (note the space), which is then followed by the style name ($2).
    // Improved upon RustyTheBoyRobot and BoltClockâ™¦ answer to allow for comments and media queries.

    // Find: ([,|\}][\s$]*)((?|\/\/.*[\s$]+|.*\/\*.*\*\/[\s$]*|@media.*\{[\s$]*|)*)([\.#]?-?[_a-zA-Z]+[_a-zA-Z0-9-]*)

    // Replace with: $1$2 #content $3
  </script>
</html>
